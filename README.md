# Сервис Назначения Ревьюеров для Pull Request'ов

## Обзор задачи
Сервис предназначен для автоматического управления Pull Request'ами (PR), командами и пользователями. Основная функция — назначение до двух активных ревьюверов из команды автора PR, а также возможность переназначения и фиксации статуса PR после мерджа. Взаимодействие осуществляется через HTTP API.

### **Бизнес-логика**
1.  **Назначение:** При создании PR автоматически назначаются **до двух** активных ревьюеров из **команды автора**, исключая самого автора
2.  **Переназначение:** Заменяет одного ревьюера на случайного **активного** участника **из команды заменяемого** ревьюера
3.  **Статус `MERGED`:** После мерджа менять список ревьюеров **нельзя**
4.  **Кандидаты:** Если доступных кандидатов меньше двух, назначается доступное количество (0 или 1)
5.  **Логика выбора:** Выбор ревьюеров осуществляется **случайным** образом (простая рандомизация без учета истории)

## Стек технологий
* Go
* PostgreSQL
* Docker

## Архитектура и Структура Проекта

Проект реализован с четким разделением слоев:
* **`cmd/`** - Точка входа (`main.go`). Инициализация всех слоев, зависимостей и запуск HTTP-сервера
* **`internal/`**
    * **`config/`** - Структуры для конфигурации приложения
    * **`domain/`** 
        * **`entity/`** - Модель данных и типизированные доменные ошибки
        * **`repository/`** - Интерфейсы репозиториев 
        * **`services/`** - Основная бизнес-логика и сервис **`Assigner`** (логика выбора ревьюверов)
    * **`infrastructure/`** 
        * **`db/postgres/`** - Реализация подключения к PostgreSQL
        * **`db/repository/`** - Реализации интерфейсов репозиториев
        * **`db/migrations/`** - SQL-файлы миграций
    * **`transport/http/`**
        * **`handler/`** - Хендлеры
        * **`router/`** - Настройка маршрутов
* **`openapi.yml`** - Спецификация API

## Принятые решения и допущения

### 1. **Атомарность**
* Для всех операций, требующих изменения состояния в нескольких таблицах (например, `Team.Create` или `PR.Reassign`), используется паттерн **Transaction Manager (`trm`)** для обеспечения **атомарности (ACID)**.
* Реализация `trm` позволяет репозиториям использовать либо активную транзакцию, либо пул соединений (если транзакция не требуется)

### 2. **Полнота сущностей в репозитории**
* В методе `PRRepository.UpdateStatus` была добавлена **дозагрузка ревьюверов** из связанной таблицы `pr_reviewers`.
* **Обоснование:** Репозиторий должен возвращать **полную** доменную сущность `PullRequest`, инкапсулируя знание о том, как собирать объект из различных таблиц, чтобы Use Case не имел логики дозагрузки данных

### 3. **Обработка ошибок**
* В доменном слое используются типизированные ошибки (`entity.ErrNotFound`, `entity.ErrPRMerged` и т.д.).
* Преобразование доменных ошибок в соответствующие HTTP-статусы и коды API (`NOT_FOUND`, `PR_MERGED`) выполняется **только** в транспортном слое (`handler/handler.go`)

### 4. **Логика выбора ревьюверов**
* Метод `Assigner.SelectReviewers` использует **случайный выбор**. История назначений не учитывается.

## Запуск проекта
Для запуска требуется **Docker** и **Docker Compose**.

1.  Склонируйте репозиторий.
2.  Создайте локальный файл конфигурации, скопировав шаблон:
    ```bash
    cp .env.template .env
    ```
3. Используйте `Makefile` для сборки и запуска всех сервисов:
```bash
make up
```
4. Проверка работоспособности
  ```bash
curl http://localhost:8080/health 
# Ожидаемый ответ: HTTP 200 OK

# Просмотр логов
make logs
```
5. Остановка
```bash
make down
```

